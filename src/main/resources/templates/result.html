<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ν€΄μ¦ κ²μ„ - κ²°κ³Ό</title>
    <link rel = "stylesheet" th:href ="@{/css/common.css}">
    <link rel = "stylesheet" th:href ="@{/css/header.css}">
    <link rel = "stylesheet" th:href ="@{/css/footer.css}">
    <link rel = "stylesheet" th:href ="@{/css/sidebar.css}">
    <link rel = "stylesheet" th:href ="@{/css/result.css}">
</head>
<body>
    <!-- ν—¤λ” -->
    <div th:replace="fragments/header ::header"></div>
    <div class="container">
        <!-- μ‚¬μ΄λ“λ°” -->
        <div th:replace="fragments/sidebar ::sidebar">
            <div th:replace="fragments/title :: title"></div>
        </div>

        <!-- λ©”μΈ μ½ν…μΈ  -->
        <div th:fragment="mainContent" class = "main-content">
            <div class="quiz-container">
                <!-- κ²°κ³Ό ν™”λ©΄ -->
                <div class="result-screen">
                    <div class="result-icon">π‰</div>
                    <div class="result-title">ν€΄μ¦ μ™„λ£!</div>
                    <p class="result-message">μκ³ ν•μ…¨μµλ‹λ‹¤!</p>

                    <div class="result-stats">
                        <div class="result-stat">
                            <div class="stat-value" th:text="${results.finalScore}">0</div>
                            <div class="stat-title">μ΄ μ μ</div>
                        </div>
                        <div class="result-stat">
                            <div class="stat-value" th:text="${results.finalAccuracyRate + '%'}">0%</div>
                            <div class="stat-title">μ •λ‹µλ¥ </div>
                        </div>
                        <div class="result-stat">
                            <div class="stat-value" th:text="${results.correctAnswerCounts + '/' + results.totalQuestions}">0/0</div>
                            <div class="stat-title">μ •λ‹µ μ</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <a th:href="@{/quiz(questionTitleId=${results.questionTitleId()})}" class="nav-btn">λ‹¤μ‹ ν•κΈ°</a>
                    </div>
                </div>

                <!-- κ³µμ μ© μΉ΄λ“ (μ¨κΉ€) -->
                <div id="shareCard" class="result-card" style="display: none;">
                    <div class="card-title">π‰ ν€΄μ¦ κ²°κ³Ό</div>
                    <div class="card-stats">
                        <div class="card-stat">
                            <div class="card-stat-value" th:text="${results.finalScore}">85</div>
                            <div class="card-stat-title">μ΄ μ μ</div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value" th:text="${results.finalAccuracyRate + '%'}">85%</div>
                            <div class="card-stat-title">μ •λ‹µλ¥ </div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value" th:text="${results.correctAnswerCounts + '/' + results.totalQuestions}">17/20</div>
                            <div class="card-stat-title">μ •λ‹µ μ</div>
                        </div>
                    </div>

                    <!-- λ¬Έν•­λ³„ μ”μ•½ -->
                    <div class="question-summary" style="margin-top: 20px; font-size: 11px; text-align: left; max-height: 180px; overflow-y: auto; line-height: 1.4;">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center; font-size: 12px; color: #333;">π“‹ λ¬Έν•­λ³„ κ²°κ³Ό</div>
                        <div th:each="result, iterStat : ${results.questionResults}"
                             style="margin-bottom: 3px; font-family: monospace; color: #333;">
                            <span th:text="${iterStat.count} + 'λ²: '">1λ²: </span>
                            <span th:if="${result.isCorrect}" style="color: #4CAF50;">
                                    <span th:text="'β… μ •λ‹µ (μ„ νƒ: ' + ${result.userAnswer} + ')'">β… μ •λ‹µ (μ„ νƒ: A)</span>
                                </span>
                            <span th:if="${!result.isCorrect and result.userAnswer != null}" style="color: #f44336;">
                                    <span th:text="'β μ¤λ‹µ (μ„ νƒ: ' + ${result.userAnswer} + ' / μ •λ‹µ: ' + ${result.correctAnswer} + ')'">β μ¤λ‹µ (μ„ νƒ: B / μ •λ‹µ: A)</span>
                                </span>
                            <span th:if="${result.userAnswer == null}" style="color: #ff9800;">
                                    <span th:text="'β λ¬΄μ‘λ‹µ (μ •λ‹µ: ' + ${result.correctAnswer} + ')'">β λ¬΄μ‘λ‹µ (μ •λ‹µ: A)</span>
                                </span>
                        </div>
                    </div>

                    <div style="font-size: 14px; opacity: 0.9; margin-top: 15px; text-align: center;">
                        ν€΄μ¦λ¥Ό μ™„λ£ν–μ–΄μ”! π€
                    </div>
                </div>

                <!-- κ³µμ  μ„Ήμ… -->
                <div class="share-section">
                    <div class="share-title">π“¤ κ²°κ³Ό κ³µμ ν•κΈ°</div>
                    <div class="share-buttons">
                        <button class="share-btn copy" onclick="copyResult()">
                            π“‹ ν…μ¤νΈ λ³µμ‚¬
                        </button>
                        <button class="share-btn copy" onclick="downloadImage()">
                            π–ΌοΈ μ΄λ―Έμ§€ μ €μ¥
                        </button>
<!--                        <button class="share-btn kakao" onclick="shareKakao()">-->
<!--                            μΉ΄μΉ΄μ¤ν†΅ κ³µμ -->
<!--                        </button>-->
                    </div>
                </div>

                <!-- λ¬Έμ λ³„ μƒμ„Έ κ²°κ³Ό -->
                <div class="detailed-results" th:if="${results.questionResults != null and !results.questionResults.isEmpty()}">
                    <div class="detailed-title">λ¬Έμ λ³„ μƒμ„Έ κ²°κ³Ό</div>

                    <div th:each="result, iterStat : ${results.questionResults}"
                         th:class="'question-result ' + ${result.isCorrect ? 'correct' : (result.userAnswer != null ? 'incorrect' : 'unanswered')}">

                        <div class="question-header">
                            <span class="question-number" th:text="'λ¬Έμ  ' + ${iterStat.count} + 'λ² [' + ${result.subjectName} + ']'">λ¬Έμ  1λ²</span>
                            <span th:class="'result-indicator ' + ${result.isCorrect ? 'correct' : (result.userAnswer != null ? 'incorrect' : 'unanswered')}"
                                  th:text="${result.isCorrect ? 'β“ μ •λ‹µ' : (result.userAnswer != null ? 'β— μ¤λ‹µ' : '- λ¬΄μ‘λ‹µ')}">β“ μ •λ‹µ</span>
                        </div>

                        <div class="question-text" th:text="${result.questionText}">λ¬Έμ  λ‚΄μ©</div>

                        <div class="answer-info">
                            <div class="answer-line" th:if="${result.userAnswer != null}">
                                <span class="answer-label">λ‚΄ λ‹µμ•:</span>
                                <span th:class="'answer-text ' + ${result.isCorrect ? 'correct' : 'incorrect'}"
                                      th:text="${result.userAnswer}">μ„ νƒν• λ‹µμ•</span>
                            </div>
                            <div class="answer-line" th:if="${result.userAnswer == null}">
                                <span class="answer-label">λ‚΄ λ‹µμ•:</span>
                                <span class="answer-text unanswered">λ―Έμ„ νƒ</span>
                            </div>
                            <div class="answer-line" th:if="${!result.isCorrect or result.userAnswer == null}">
                                <span class="answer-label">μ •λ‹µ:</span>
                                <span class="answer-text correct" th:text="${result.correctAnswer}">μ •λ‹µ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- λ³µμ‚¬ μ„±κ³µ λ©”μ‹μ§€ -->
    <div id="copySuccess" class="copy-success">
        ν΄λ¦½λ³΄λ“μ— λ³µμ‚¬λμ—μµλ‹λ‹¤! π“‹
    </div>

    <!-- ν‘Έν„° -->
    <div th:replace="fragments/footer ::footer"></div>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/sidebar.js}"></script>
    <script th:inline="javascript">
        // μ„λ²„μ—μ„ μ „λ‹¬λ°›μ€ λ°μ΄ν„°
        const resultData = {
            score: [[${results.finalScore}]],
            accuracy: [[${results.finalAccuracyRate}]],
            correct: [[${results.correctAnswerCounts}]],
            total: [[${results.totalQuestions}]]
        };

        // ν…μ¤νΈλ΅ κ²°κ³Ό λ³µμ‚¬
        function copyResult() {
            // λ¬Έν•­λ³„ κ²°κ³Ό μ”μ•½ μƒμ„±
            const questionResults = [];
            document.querySelectorAll('.question-result').forEach((element, index) => {
                const questionNumber = index + 1;
                const subjectName = element.querySelector('.question-number').textContent.match(/\[(.*?)\]/)?.[1] || '';
                const isCorrect = element.classList.contains('correct');
                const isUnanswered = element.classList.contains('unanswered');

                // λ‚΄ λ‹µμ•κ³Ό μ •λ‹µ μ°ΎκΈ°
                const answerLines = element.querySelectorAll('.answer-line');
                let myAnswer = '';
                let correctAnswer = '';

                answerLines.forEach(line => {
                    const label = line.querySelector('.answer-label').textContent;
                    const answerText = line.querySelector('.answer-text');

                    if (label.includes('λ‚΄ λ‹µμ•')) {
                        myAnswer = answerText.textContent.trim();
                    } else if (label.includes('μ •λ‹µ')) {
                        correctAnswer = answerText.textContent.trim();
                    }
                });

                let status = '';
                let answerInfo = '';

                if (isCorrect) {
                    status = 'β… μ •λ‹µ';
                    answerInfo = `(μ„ νƒ: ${myAnswer})`;
                } else if (isUnanswered || myAnswer === 'λ―Έμ„ νƒ') {
                    status = 'β λ¬΄μ‘λ‹µ';
                    answerInfo = `(μ •λ‹µ: ${correctAnswer})`;
                } else {
                    status = 'β μ¤λ‹µ';
                    answerInfo = `(μ„ νƒ: ${myAnswer} / μ •λ‹µ: ${correctAnswer})`;
                }

                questionResults.push(`${questionNumber}λ² [${subjectName}]: ${status} ${answerInfo}`);
            });

            const questionSummary = questionResults.length > 0 ?
                `\n\nπ“‹ λ¬Έν•­λ³„ κ²°κ³Ό:\n${questionResults.join('\n')}` : '';

            const text = `π‰ ν€΄μ¦ κ²°κ³Ό π‰

π“ μ΄ μ μ: ${resultData.score}μ 
π― μ •λ‹µλ¥ : ${resultData.accuracy}%
β… μ •λ‹µ μ: ${resultData.correct}/${resultData.total}${questionSummary}

ν€΄μ¦λ¥Ό μ™„λ£ν–μ–΄μ”! π€`;

            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('λ³µμ‚¬ μ‹¤ν¨:', err);
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopySuccess();
            });
        }

        // μ΄λ―Έμ§€λ΅ μ €μ¥
        function downloadImage() {
            const shareCard = document.getElementById('shareCard');
            shareCard.style.display = 'block';

            html2canvas(shareCard, {
                backgroundColor: null,
                scale: 2,
                useCORS: true
            }).then(canvas => {
                shareCard.style.display = 'none';

                // μ΄λ―Έμ§€ λ‹¤μ΄λ΅λ“
                const link = document.createElement('a');
                link.download = `quiz-result-${new Date().getTime()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // μΉ΄μΉ΄μ¤ν†΅ κ³µμ 
        function shareKakao() {
            if (typeof Kakao !== 'undefined') {
                Kakao.Share.sendDefault({
                    objectType: 'feed',
                    content: {
                        title: 'π‰ ν€΄μ¦ κ²°κ³Ό',
                        description: `μ μ: ${resultData.score}μ  | μ •λ‹µλ¥ : ${resultData.accuracy}% | μ •λ‹µμ: ${resultData.correct}/${resultData.total}`,
                        imageUrl: window.location.origin + '/images/quiz-share.png',
                        link: {
                            mobileWebUrl: window.location.href,
                            webUrl: window.location.href
                        }
                    }
                });
            } else {
                alert('μΉ΄μΉ΄μ¤ν†΅ SDKκ°€ λ΅λ“λμ§€ μ•μ•μµλ‹λ‹¤.');
            }
        }

        // λ³µμ‚¬ μ„±κ³µ λ©”μ‹μ§€ ν‘μ‹
        function showCopySuccess() {
            const successMsg = document.getElementById('copySuccess');
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 2000);
        }

        // νμ΄μ§€ λ΅λ“ μ‹ μΉ΄μΉ΄μ¤ SDK μ΄κΈ°ν™” (ν•„μ”ν• κ²½μ°)
        // Kakao.init('YOUR_KAKAO_APP_KEY');
    </script>
</body>
</html>